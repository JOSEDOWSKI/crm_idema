<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Reportes - Análisis de Datos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1000px;
        }
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid rgba(0, 0, 0, 0.125);
        }
        .form-label {
            font-weight: 600;
            color: #495057;
        }
        .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .btn-success {
            background-color: #198754;
            border-color: #198754;
        }
        .btn-info {
            background-color: #0dcaf0;
            border-color: #0dcaf0;
        }
        #fecha-fin-group {
            display: none;
        }
        .loading {
            display: none;
        }
        .alert {
            margin-top: 1rem;
        }
        .preview-modal .modal-body {
            max-height: 500px;
            overflow-y: auto;
        }
        .preview-content {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h2 class="card-title mb-0">
                            <i class="fas fa-chart-line me-2"></i>
                            Generador de Reportes - Análisis de Datos
                        </h2>
                    </div>
                    <div class="card-body">
                        <form id="reporteForm">
                            <!-- Sección de Tipo de Reporte -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h5 class="text-primary mb-3">Tipo de Reporte</h5>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="tipo_reporte" id="dia_unico" value="dia_unico" checked>
                                        <label class="form-check-label" for="dia_unico">
                                            Reporte de un día
                                        </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="tipo_reporte" id="varios_dias" value="varios_dias">
                                        <label class="form-check-label" for="varios_dias">
                                            Reporte de varios días
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Sección de Fechas -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h5 class="text-primary mb-3">Selección de Fechas</h5>
                                </div>
                                <div class="col-md-6" id="fecha-inicio-group">
                                    <label for="fecha_inicio" class="form-label">Fecha del reporte:</label>
                                    <input type="text" class="form-control" id="fecha_inicio" name="fecha_inicio" required>
                                </div>
                                <div class="col-md-6" id="fecha-fin-group">
                                    <label for="fecha_fin" class="form-label">Fecha fin:</label>
                                    <input type="text" class="form-control" id="fecha_fin" name="fecha_fin">
                                </div>
                            </div>

                            <!-- Sección de Métricas -->
                            <div class="row mb-4" id="metricas-section">
                                <div class="col-12">
                                    <h5 class="text-primary mb-3">Datos del Reporte</h5>
                                </div>
                                
                                <!-- Formulario para un día -->
                                <div id="formulario-un-dia">
                                    <!-- Métricas Mes Actual -->
                                    <div class="col-md-6">
                                        <h6 class="text-secondary mb-3">Mes Actual</h6>
                                        <div class="mb-3">
                                            <label for="visitas_unicas_actual" class="form-label">Visitas únicas:</label>
                                            <input type="text" class="form-control" id="visitas_unicas_actual" name="visitas_unicas_actual" value="282">
                                        </div>
                                        <div class="mb-3">
                                            <label for="paginas_actual" class="form-label">Páginas más vistas:</label>
                                            <input type="text" class="form-control" id="paginas_actual" name="paginas_actual" value="/, idema-educa">
                                        </div>
                                        <div class="mb-3">
                                            <label for="tiempo_actual" class="form-label">Tiempo promedio:</label>
                                            <input type="text" class="form-control" id="tiempo_actual" name="tiempo_actual" value="30seg">
                                        </div>
                                        <div class="mb-3">
                                            <label for="clics_actual" class="form-label">Clics WhatsApp:</label>
                                            <input type="text" class="form-control" id="clics_actual" name="clics_actual" value="20">
                                        </div>
                                        <div class="mb-3">
                                            <label for="dispositivos_actual" class="form-label">Dispositivos más usados:</label>
                                            <input type="text" class="form-control" id="dispositivos_actual" name="dispositivos_actual" value="Desktop">
                                        </div>
                                        <div class="mb-3">
                                            <label for="problemas_actual" class="form-label">Problemas detectados:</label>
                                            <input type="text" class="form-control" id="problemas_actual" name="problemas_actual" value="301">
                                        </div>
                                        <div class="mb-3">
                                            <label for="vendedora_actual" class="form-label">Vendedora más seleccionada:</label>
                                            <input type="text" class="form-control" id="vendedora_actual" name="vendedora_actual" value="Dayana">
                                        </div>
                                    </div>

                                    <!-- Métricas Mes Anterior -->
                                    <div class="col-md-6">
                                        <h6 class="text-secondary mb-3">Mes Anterior</h6>
                                        <div class="mb-3">
                                            <label for="visitas_unicas_anterior" class="form-label">Visitas únicas:</label>
                                            <input type="text" class="form-control" id="visitas_unicas_anterior" name="visitas_unicas_anterior" value="234">
                                        </div>
                                        <div class="mb-3">
                                            <label for="paginas_anterior" class="form-label">Páginas más vistas:</label>
                                            <input type="text" class="form-control" id="paginas_anterior" name="paginas_anterior" value="/, sobre-nosotros">
                                        </div>
                                        <div class="mb-3">
                                            <label for="tiempo_anterior" class="form-label">Tiempo promedio:</label>
                                            <input type="text" class="form-control" id="tiempo_anterior" name="tiempo_anterior" value="30seg">
                                        </div>
                                        <div class="mb-3">
                                            <label for="clics_anterior" class="form-label">Clics WhatsApp:</label>
                                            <input type="text" class="form-control" id="clics_anterior" name="clics_anterior" value="Sin datos">
                                        </div>
                                        <div class="mb-3">
                                            <label for="dispositivos_anterior" class="form-label">Dispositivos más usados:</label>
                                            <input type="text" class="form-control" id="dispositivos_anterior" name="dispositivos_anterior" value="Desktop">
                                        </div>
                                        <div class="mb-3">
                                            <label for="problemas_anterior" class="form-label">Problemas detectados:</label>
                                            <input type="text" class="form-control" id="problemas_anterior" name="problemas_anterior" value="404">
                                        </div>
                                        <div class="mb-3">
                                            <label for="vendedora_anterior" class="form-label">Vendedora más seleccionada:</label>
                                            <input type="text" class="form-control" id="vendedora_anterior" name="vendedora_anterior" value="Sin datos">
                                        </div>
                                    </div>

                                    <!-- Métricas Adicionales -->
                                    <div class="col-12">
                                        <h6 class="text-secondary mb-3">Métricas Adicionales</h6>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="test_vocacional" class="form-label">Test Vocacional:</label>
                                                    <input type="text" class="form-control" id="test_vocacional" name="test_vocacional" value="Vinculado directamente al Form">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="formulario" class="form-label">Formulario:</label>
                                                    <input type="text" class="form-control" id="formulario" name="formulario" value="3">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Formulario para varios días -->
                                <div id="formulario-varios-dias" style="display: none;">
                                    <div class="col-12">
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            Selecciona las fechas primero para generar los formularios de cada día.
                                        </div>
                                        <button type="button" class="btn btn-primary mb-3" id="btnGenerarFormularios">
                                            <i class="fas fa-plus me-1"></i>Generar Formularios por Día
                                        </button>
                                        <div id="formularios-dinamicos"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Sección de Observaciones -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h5 class="text-primary mb-3">Observaciones</h5>
                                    <textarea class="form-control" id="observaciones" name="observaciones" rows="4" placeholder="Escribe tus observaciones aquí...">Disminuyeron las visitas, aun se mantiene por encima del mes anterior pero no sigue la tendencia de subida que tenia, 3 registros del formulario</textarea>
                                </div>
                            </div>

                            <!-- Botones -->
                            <div class="row">
                                <div class="col-12 text-center">
                                    <button type="button" class="btn btn-info me-2" id="btnVistaPrevia">
                                        <i class="fas fa-eye me-1"></i>Vista Previa
                                    </button>
                                    <button type="submit" class="btn btn-success me-2">
                                        <i class="fas fa-file-pdf me-1"></i>Generar Reporte PDF
                                    </button>
                                    <div class="loading">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Generando...</span>
                                        </div>
                                        <span class="ms-2">Generando reporte...</span>
                                    </div>
                                </div>
                            </div>
                        </form>

                        <!-- Área de mensajes -->
                        <div id="mensajes"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Vista Previa -->
    <div class="modal fade preview-modal" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Vista Previa del Reporte LaTeX</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="preview-content" id="previewContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    <script>
        // Configurar calendarios
        const fechaInicio = flatpickr("#fecha_inicio", {
            locale: "es",
            dateFormat: "Y-m-d",
            defaultDate: "today"
        });

        const fechaFin = flatpickr("#fecha_fin", {
            locale: "es",
            dateFormat: "Y-m-d",
            defaultDate: "today"
        });

        // Manejar cambio de tipo de reporte
        document.querySelectorAll('input[name="tipo_reporte"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const fechaFinGroup = document.getElementById('fecha-fin-group');
                const fechaInicioLabel = document.querySelector('label[for="fecha_inicio"]');
                const formularioUnDia = document.getElementById('formulario-un-dia');
                const formularioVariosDias = document.getElementById('formulario-varios-dias');
                
                if (this.value === 'varios_dias') {
                    fechaFinGroup.style.display = 'block';
                    fechaInicioLabel.textContent = 'Fecha inicio:';
                    formularioUnDia.style.display = 'none';
                    formularioVariosDias.style.display = 'block';
                } else {
                    fechaFinGroup.style.display = 'none';
                    fechaInicioLabel.textContent = 'Fecha del reporte:';
                    formularioUnDia.style.display = 'block';
                    formularioVariosDias.style.display = 'none';
                }
            });
        });

        // Generar formularios dinámicos para varios días
        document.getElementById('btnGenerarFormularios').addEventListener('click', function() {
            const fechaInicio = document.getElementById('fecha_inicio').value;
            const fechaFin = document.getElementById('fecha_fin').value;
            
            if (!fechaInicio || !fechaFin) {
                mostrarMensaje('warning', 'Por favor selecciona las fechas de inicio y fin.');
                return;
            }
            
            const fechas = generarRangoFechas(fechaInicio, fechaFin);
            const container = document.getElementById('formularios-dinamicos');
            
            // Limpiar formularios anteriores
            container.innerHTML = '';
            
            fechas.forEach((fecha, index) => {
                const fechaFormateada = formatearFecha(fecha);
                const formularioHTML = crearFormularioDia(fecha, fechaFormateada, index);
                container.innerHTML += formularioHTML;
            });
            
            mostrarMensaje('success', `Se generaron formularios para ${fechas.length} días.`);
        });

        function generarRangoFechas(fechaInicio, fechaFin) {
            const fechas = [];
            const inicio = new Date(fechaInicio);
            const fin = new Date(fechaFin);
            
            for (let fecha = new Date(inicio); fecha <= fin; fecha.setDate(fecha.getDate() + 1)) {
                fechas.push(new Date(fecha).toISOString().split('T')[0]);
            }
            
            return fechas;
        }

        function formatearFecha(fecha) {
            const opciones = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                locale: 'es-ES'
            };
            return new Date(fecha).toLocaleDateString('es-ES', opciones);
        }

        function crearFormularioDia(fecha, fechaFormateada, index) {
            return `
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">
                            <i class="fas fa-calendar-day me-2"></i>
                            Métricas para ${fechaFormateada}
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="text-secondary mb-3">Métricas Principales</h6>
                                <div class="mb-3">
                                    <label class="form-label">Visitas únicas:</label>
                                    <input type="text" class="form-control" name="dia_${index}_visitas_unicas" value="${Math.floor(Math.random() * 300) + 200}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Páginas más vistas:</label>
                                    <input type="text" class="form-control" name="dia_${index}_paginas_vistas" value="/, idema-educa">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Tiempo promedio:</label>
                                    <input type="text" class="form-control" name="dia_${index}_tiempo_promedio" value="30seg">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-secondary mb-3">Interacciones</h6>
                                <div class="mb-3">
                                    <label class="form-label">Clics WhatsApp:</label>
                                    <input type="text" class="form-control" name="dia_${index}_clics_whatsapp" value="${Math.floor(Math.random() * 30) + 10}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Dispositivos más usados:</label>
                                    <input type="text" class="form-control" name="dia_${index}_dispositivos" value="Desktop">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Problemas detectados:</label>
                                    <input type="text" class="form-control" name="dia_${index}_problemas" value="301">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-secondary mb-3">Otros</h6>
                                <div class="mb-3">
                                    <label class="form-label">Vendedora más seleccionada:</label>
                                    <input type="text" class="form-control" name="dia_${index}_vendedora" value="Dayana">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Test Vocacional:</label>
                                    <input type="text" class="form-control" name="dia_${index}_test_vocacional" value="Vinculado al Form">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Formularios:</label>
                                    <input type="text" class="form-control" name="dia_${index}_formularios" value="${Math.floor(Math.random() * 5) + 1}">
                                </div>
                            </div>
                        </div>
                        <input type="hidden" name="dia_${index}_fecha" value="${fecha}">
                    </div>
                </div>
            `;
        }

        // Manejar envío del formulario
        document.getElementById('reporteForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const loading = document.querySelector('.loading');
            const submitBtn = document.querySelector('button[type="submit"]');
            
            // Mostrar loading
            loading.style.display = 'inline-block';
            submitBtn.disabled = true;
            
            fetch('/generar_reporte', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                submitBtn.disabled = false;
                
                if (data.success) {
                    mostrarMensaje('success', data.message);
                    // Crear enlace de descarga
                    const downloadLink = document.createElement('a');
                    downloadLink.href = data.download_url;
                    downloadLink.download = data.filename;
                    downloadLink.textContent = 'Descargar Reporte PDF';
                    downloadLink.className = 'btn btn-primary mt-2';
                    
                    const mensajesDiv = document.getElementById('mensajes');
                    const alertDiv = mensajesDiv.querySelector('.alert-success');
                    if (alertDiv) {
                        alertDiv.appendChild(document.createElement('br'));
                        alertDiv.appendChild(downloadLink);
                    }
                } else {
                    mostrarMensaje('danger', data.message);
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                submitBtn.disabled = false;
                mostrarMensaje('danger', 'Error de conexión: ' + error.message);
            });
        });

        // Manejar vista previa
        document.getElementById('btnVistaPrevia').addEventListener('click', function() {
            const formData = new FormData(document.getElementById('reporteForm'));
            
            fetch('/vista_previa', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('previewContent').textContent = data.latex_content;
                    new bootstrap.Modal(document.getElementById('previewModal')).show();
                } else {
                    mostrarMensaje('danger', data.message);
                }
            })
            .catch(error => {
                mostrarMensaje('danger', 'Error al generar vista previa: ' + error.message);
            });
        });

        function mostrarMensaje(tipo, mensaje) {
            const mensajesDiv = document.getElementById('mensajes');
            mensajesDiv.innerHTML = `
                <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
                    ${mensaje}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }
    </script>
</body>
</html>