{% extends 'gestion/base.html' %}
{% load i18n %}

{% block title %}Dashboard de Gestión{% endblock %}

{% block content %}
{{ leads_canal_data_json|json_script:"leads_canal_data" }}
{{ conversiones_asesor_data_json|json_script:"conversiones_asesor_data" }}
{{ ingresos_programa_data_json|json_script:"ingresos_programa_data" }}

<div class="container-fluid mt-4">
    <h2 class="mb-4">Dashboard de Gestión</h2>

    <!-- KPIs Principales -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Alumnos (Clientes)</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_alumnos }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Monto Total Recaudado</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">S/ {{ monto_recaudado|floatformat:2 }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Tasa de Conversión</div>
                            <div class="h5 mb-0 mr-3 font-weight-bold text-gray-800">{{ tasa_conversion|floatformat:2 }}%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Tasa de Retención (Matrículas Activas)</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ tasa_retencion|floatformat:2 }}%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos y Tablas -->
    <div class="row">

        <!-- Columna Izquierda -->
        <div class="col-lg-7">
            
            <!-- Gráfico: Ingresos por Programa -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Ingresos por Programa Académico</h6>
                </div>
                <div class="card-body">
                    <div class="chart-bar">
                        <canvas id="ingresosProgramaChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Gráfico: Conversiones por Asesor -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Conversiones por Asesor</h6>
                </div>
                <div class="card-body">
                    <div class="chart-bar">
                        <canvas id="conversionesAsesorChart"></canvas>
                    </div>
                </div>
            </div>

        </div>

        <!-- Columna Derecha -->
        <div class="col-lg-5">

            <!-- Gráfico: Leads por Canal -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Origen de Leads por Canal</h6>
                </div>
                <div class="card-body">
                    <div class="chart-pie pt-4 mb-4">
                        <canvas id="leadsCanalChart"></canvas>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered" width="100%" cellspacing="0">
                            <thead><tr><th>Canal</th><th class="text-end">Leads</th></tr></thead>
                            <tbody>
                                {% for item in leads_por_canal %}
                                <tr><td>{{ item.nombre_medio }}</td><td class="text-end">{{ item.num_leads }}</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tabla: Programas más Populares -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Programas más Populares</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered" width="100%" cellspacing="0">
                           <thead>
                                <tr>
                                    <th>Programa</th>
                                    <th class="text-end">Inscritos</th>
                                </tr>
                           </thead>
                           <tbody>
                                {% for programa in programas_populares %}
                                <tr>
                                    <td>{{ programa.nombre_programa }}</td>
                                    <td class="text-end">{{ programa.num_inscritos }}</td>
                                </tr>
                                {% endfor %}
                           </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // Función para generar colores aleatorios para los gráficos
    const getRandomColor = (alpha = 1) => `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${alpha})`;
    const getColors = (count) => Array.from({ length: count }, () => getRandomColor(0.7));
    const getBorderColors = (count) => Array.from({ length: count }, () => getRandomColor(1));

    // Gráfico 1: Leads por Canal (Doughnut)
    const leadsCanalData = JSON.parse(document.getElementById('leads_canal_data').textContent);
    const leadsCanalCtx = document.getElementById('leadsCanalChart').getContext('2d');
    if (leadsCanalData.labels.length > 0) {
        new Chart(leadsCanalCtx, {
            type: 'doughnut',
            data: {
                labels: leadsCanalData.labels,
                datasets: [{
                    data: leadsCanalData.data,
                    backgroundColor: getColors(leadsCanalData.labels.length),
                    borderColor: getBorderColors(leadsCanalData.labels.length),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                }
            }
        });
    }

    // Gráfico 2: Conversiones por Asesor (Bar)
    const conversionesAsesorData = JSON.parse(document.getElementById('conversiones_asesor_data').textContent);
    const conversionesAsesorCtx = document.getElementById('conversionesAsesorChart').getContext('2d');
    if (conversionesAsesorData.labels.length > 0) {
        new Chart(conversionesAsesorCtx, {
            type: 'bar',
            data: {
                labels: conversionesAsesorData.labels,
                datasets: [{
                    label: 'Conversiones',
                    data: conversionesAsesorData.data,
                    backgroundColor: getColors(conversionesAsesorData.labels.length),
                    borderColor: getBorderColors(conversionesAsesorData.labels.length),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    // Gráfico 3: Ingresos por Programa (Horizontal Bar)
    const ingresosProgramaData = JSON.parse(document.getElementById('ingresos_programa_data').textContent);
    const ingresosProgramaCtx = document.getElementById('ingresosProgramaChart').getContext('2d');
    if (ingresosProgramaData.labels.length > 0) {
        new Chart(ingresosProgramaCtx, {
            type: 'bar',
            data: {
                labels: ingresosProgramaData.labels,
                datasets: [{
                    label: 'Ingresos (S/)',
                    data: ingresosProgramaData.data,
                    backgroundColor: getColors(ingresosProgramaData.labels.length),
                    borderColor: getBorderColors(ingresosProgramaData.labels.length),
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y', // <-- Esto lo hace horizontal
                responsive: true,
                maintainAspectRatio: true,
                 scales: {
                    x: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

});
</script>
{% endblock %} 